google.load("visualization","1",{});$(document).ready(function(){$("#help-address").tooltip();var h={};h.mapDOM=document.getElementById("theMap");h.CenterLatLng=new google.maps.LatLng("41.845","-87.669");h.potholeLayer=null;h.potholeTableId="3142020";h.potholeColumn="LOCATION";h.wardLayer=null;h.wardTableId="3057562";h.wardColumn="geometry";h.queryString=null;h.countQueryString=null;h.insertAnd="";h.geocoder=new google.maps.Geocoder();h.searchRadius="805";h.addrMarker=false;h.isStatsRequest=false;h.isAddressRequest=false;h.createDates=new Array();h.completeDates=new Array();h.dateDiffs=new Array();h.total=new Array();h.flot=new Array();h.openComplete=null;h.i=null;h.statResults={};h.queryText=null;h.numRows=null;h.subStr=null;h.subStr1=null;h.subStr2=null;h.regex=null;h.myOptions={zoom:11,mapTypeControl:true,streetViewControl:false,panControl:false,zoomControl:true,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.LEFT_TOP},mapTypeId:google.maps.MapTypeId.TERRAIN};h.radiusCircle=null;h.radiusCircleOptions=null;h.theMap=new google.maps.Map(h.mapDOM,h.myOptions);h.theMap.setCenter(h.CenterLatLng);function l(){h.isStatsRequest=false;h.queryString="SELECT "+h.potholeColumn+" FROM "+h.potholeTableId}l();h.potholeLayer=new google.maps.FusionTablesLayer(h.potholeTableId,{query:h.queryString});h.potholeLayer.setMap(h.theMap);e(h.queryString,false);$("#map-refresh").click(function(){h.yearCreation=$("#year-creation").val();h.yearCompleted=$("#year-completed").val();h.address=$("#address").val();if(h.yearCreation=="none"||h.yearCompleted=="none"){$("#yearWarn").html('<div class="alert alert-error alert-block"><a class="close" data-dismiss="alert">x</a>Choose both a Request and Completion year.</div>')}else{l();if(h.yearCreation!="all"||h.yearCompleted!="all"){h.queryString=h.queryString+" WHERE "+h.potholeColumn+" NOT EQUAL TO '' AND";if(h.yearCreation!="all"){h.queryString=h.queryString+" CREATIONDATE >= '01/01/"+h.yearCreation+"' AND CREATIONDATE <= '12/31/"+h.yearCreation+"'";h.insertAnd=" AND"}if(h.yearCompleted!="open"&&h.yearCompleted!="all"){h.isStatsRequest=true;h.queryString=h.queryString+h.insertAnd+" COMPLETIONDATE >= '01/01/"+h.yearCompleted+"' AND COMPLETIONDATE <= '12/31/"+h.yearCompleted+"'"}if(h.yearCompleted=="open"){h.isStatsRequest=true;h.queryString=h.queryString+h.insertAnd+" STATUS LIKE '%Open%'"}if(h.yearCompleted=="all"){h.isStatsRequest=true;h.queryString=h.queryString+h.insertAnd+" STATUS LIKE '%Completed%'"}}else{h.isStatsRequest=true;h.queryString=h.queryString+" WHERE STATUS LIKE '%Completed%' AND "+h.potholeColumn+" NOT EQUAL TO ''"}if(h.address!=""){h.isAddressRequest=true;h.address+=" Chicago IL";h.geocoder.geocode({address:h.address},function(n,m){if(m==google.maps.GeocoderStatus.OK){if(h.addrMarker!=false){h.addrMarker.setMap(null)}h.theMap.setCenter(n[0].geometry.location);h.theMap.setZoom(14);h.addrMarker=new google.maps.Marker({position:n[0].geometry.location,map:h.theMap,animation:google.maps.Animation.DROP,title:h.address});if(h.radiusCircle!=null){h.radiusCircle.setMap(null)}f(n[0].geometry.location);h.queryString=h.queryString+" AND ST_INTERSECTS("+h.potholeColumn+", CIRCLE(LATLNG"+n[0].geometry.location.toString()+","+h.searchRadius+"))";i(h.queryString)}else{alert("We could not locate your address: "+m)}})}else{if(h.addrMarker!=false){h.addrMarker.setMap(null)}if(h.radiusCircle!=null){h.radiusCircle.setMap(null)}h.isAddressRequest=false;$("#statResults").fadeOut(function(){$("#statResults").html("")});i(h.queryString)}}});function f(m){h.radiusCircleOptions={strokeColor:"#a0522d",strokeOpacity:0.4,strokeWeight:1,fillColor:"#a0522d",fillOpacity:0.05,map:h.theMap,center:m,clickable:false,zIndex:-1,radius:parseInt(h.searchRadius)};h.radiusCircle=new google.maps.Circle(h.radiusCircleOptions)}$("#map-all").click(function(){l();if(h.addrMarker!=false){h.addrMarker.setMap(null)}if(h.radiusCircle!=null){h.radiusCircle.setMap(null)}i(h.queryString);$("#year-creation").val("none");$("#year-completed").val("none");$("#address").val("");$("#statResults").fadeOut(function(){$("#statResults").html("")})});function i(m){h.potholeLayer.setMap(null);h.potholeLayer=new google.maps.FusionTablesLayer(h.potholeTableId,{query:m});h.potholeLayer.setMap(h.theMap);e(m)}h.wardLayer=new google.maps.FusionTablesLayer(h.wardTableId,{query:"SELECT "+h.wardColumn+" FROM "+h.wardTableId});$("#wards").click(function(){if($("#wards").is(":checked")){h.potholeLayer.setMap(null);h.wardLayer.setMap(h.theMap);h.potholeLayer.setMap(h.theMap)}else{h.wardLayer.setMap(null)}});function e(m){$("#numResults").fadeOut(function(){$("#numResults").html('<div class="alert"><strong>Calculating...</strong></div>')});$("#numResults").fadeIn(function(){h.countQueryString=m.replace("SELECT "+h.potholeColumn,"SELECT Count() ");b(h.countQueryString).send(j);if(h.isStatsRequest){c(m)}})}function b(m){h.queryText=encodeURIComponent(m);return new google.visualization.Query("http://www.google.com/fusiontables/gvizdata?tq="+h.queryText)}function j(m){h.numRows=0;if(m.getDataTable().getNumberOfRows()>0){h.numRows=parseInt(m.getDataTable().getValue(0,0))}$("#numResults").fadeOut(function(){$("#statsResults").fadeOut();$("#numResults").html('<div class="alert alert-info"><strong>'+g(h.numRows)+"</strong> Requests Selected</div>")});$("#numResults").fadeIn()}function c(m){h.statQueryString=m.replace("SELECT "+h.potholeColumn,"SELECT CREATIONDATE, COMPLETIONDATE");h.queryText=encodeURIComponent(h.statQueryString);h.jqxhr=$.get("http://www.google.com/fusiontables/api/query?sql="+h.queryText+"&jsonCallback=?",a,"jsonp")}function a(m){k(m.table.rows)}function k(m){h.dateDiffs=new Array();h.numStatsRows=parseInt(m.length);for(h.i=1;h.i<=6;h.i++){h.total[h.i]=0}for(h.i=0;h.i<h.numStatsRows;h.i++){h.createDates[h.i]=new XDate(m[h.i][0]);if(m[h.i][1]!=""){h.openComplete="DAYS TO COMPLETE REQUESTS";h.completeDates[h.i]=new XDate(m[h.i][1])}else{h.openComplete="DAYS SINCE REQUESTS OPENED";h.completeDates[h.i]=new XDate()}h.dateDiffs[h.i]=h.createDates[h.i].diffDays(h.completeDates[h.i]);if(h.dateDiffs[h.i]<3){h.total[1]++}else{if(h.dateDiffs[h.i]<6){h.total[2]++}else{if(h.dateDiffs[h.i]<9){h.total[3]++}else{if(h.dateDiffs[h.i]<12){h.total[4]++}else{if(h.dateDiffs[h.i]<15){h.total[5]++}else{h.total[6]++}}}}}}h.statResults.min=jStat.min(h.dateDiffs);h.statResults.max=jStat.max(h.dateDiffs);h.statResults.mean=jStat.mean(h.dateDiffs);h.statResults.median=jStat.median(h.dateDiffs);h.statResults.stdev=jStat.stdev(h.dateDiffs);for(h.i=1;h.i<=6;h.i++){h.flot[h.i]=[h.i,h.total[h.i]]}$("#statResults").fadeOut(function(){$("#statResults").html('<div class="alert alert-info"><strong>'+h.openComplete+"<br/>"+d(h.statResults.min,0)+"</strong> minimum<br/><strong>"+d(h.statResults.max,0)+"</strong> maximum<br/><strong>"+d(h.statResults.mean,0)+"</strong> average<br/><strong>"+d(h.statResults.median,0)+"</strong> median<br/><strong>"+d(h.statResults.stdev,0)+'</strong> standard deviation<div id="flot" style="width:240px;height:100px"></div><p>&nbsp;<br/>requests - vertical&nbsp;&nbsp;|&nbsp;&nbsp;days - horizonal</p></div>');$.plot($("#flot"),[{color:"rgba(255,50,50,0.66)",data:h.flot}],{bars:{show:true,fillColor:"rgba(255,50,50,0.25)"},xaxis:{ticks:[[1,"0"],[2,"3"],[3,"6"],[4,"9"],[5,"12"],[6,"15"],[7,"&#x221E;"]]}})});$("#statResults").fadeIn()}function g(m){m+="";h.subStr=m.split(".");h.subStr1=h.subStr[0];h.subStr2=h.subStr.length>1?"."+h.subStr[1]:"";h.regx=/(\d+)(\d{3})/;while(h.regx.test(h.subStr1)){h.subStr1=h.subStr1.replace(h.regx,"$1,$2")}return h.subStr1+h.subStr2}function d(m,n){h.roundResult=Math.round(m*Math.pow(10,n))/Math.pow(10,n);return h.roundResult}});