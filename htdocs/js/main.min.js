google.load("visualization","1",{});$(document).ready(function(){$("#help-address").tooltip();var g={};g.mapDOM=document.getElementById("theMap");g.CenterLatLng=new google.maps.LatLng("41.845","-87.669");g.potholeLayer=null;g.potholeTableId="3142020";g.potholeColumn="LOCATION";g.wardLayer=null;g.wardTableId="3057562";g.wardColumn="geometry";g.queryString=null;g.countQueryString=null;g.insertAnd="";g.geocoder=new google.maps.Geocoder();g.searchRadius="805";g.addrMarker=false;g.isStatsRequest=false;g.isAddressRequest=false;g.createDates=new Array();g.completeDates=new Array();g.dateDiffs=new Array();g.total=new Array();g.flot=new Array();g.openComplete=null;g.i=null;g.statResults={};g.queryText=null;g.numRows=null;g.subStr=null;g.subStr1=null;g.subStr2=null;g.regex=null;g.myOptions={zoom:11,mapTypeControl:true,streetViewControl:false,panControl:false,zoomControl:true,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL,position:google.maps.ControlPosition.LEFT_TOP},mapTypeId:google.maps.MapTypeId.TERRAIN};g.radiusCircle=null;g.radiusCircleOptions=null;g.theMap=new google.maps.Map(g.mapDOM,g.myOptions);g.theMap.setCenter(g.CenterLatLng);function k(){g.isStatsRequest=false;g.queryString="SELECT "+g.potholeColumn+" FROM "+g.potholeTableId}k();g.potholeLayer=new google.maps.FusionTablesLayer(g.potholeTableId,{query:g.queryString});g.potholeLayer.setMap(g.theMap);d(g.queryString,false);$("#map-refresh").click(function(){g.yearCreation=$("#year-creation").val();g.yearCompleted=$("#year-completed").val();g.address=$("#address").val();if(g.yearCreation=="none"||g.yearCompleted=="none"){$("#yearWarn").html('<div class="alert alert-error alert-block"><a class="close" data-dismiss="alert">x</a>Choose both a Request and Completion year.</div>')}else{k();if(g.yearCreation!="all"||g.yearCompleted!="all"){g.queryString=g.queryString+" WHERE "+g.potholeColumn+" NOT EQUAL TO '' AND";if(g.yearCreation!="all"){g.queryString=g.queryString+" CREATIONDATE >= '01/01/"+g.yearCreation+"' AND CREATIONDATE <= '12/31/"+g.yearCreation+"'";g.insertAnd=" AND"}if(g.yearCompleted!="open"&&g.yearCompleted!="all"){g.isStatsRequest=true;g.queryString=g.queryString+g.insertAnd+" COMPLETIONDATE >= '01/01/"+g.yearCompleted+"' AND COMPLETIONDATE <= '12/31/"+g.yearCompleted+"'"}if(g.yearCompleted=="open"){g.isStatsRequest=true;g.queryString=g.queryString+g.insertAnd+" STATUS LIKE '%Open%'"}if(g.yearCompleted=="all"){g.isStatsRequest=true;g.queryString=g.queryString+g.insertAnd+" STATUS LIKE '%Completed%'"}}else{g.isStatsRequest=true;g.queryString=g.queryString+" WHERE STATUS LIKE '%Completed%' AND "+g.potholeColumn+" NOT EQUAL TO ''"}if(g.address!=""){g.isAddressRequest=true;g.address+=" Chicago IL";g.geocoder.geocode({address:g.address},function(m,l){if(l==google.maps.GeocoderStatus.OK){if(g.addrMarker!=false){g.addrMarker.setMap(null)}g.theMap.setCenter(m[0].geometry.location);g.theMap.setZoom(14);g.addrMarker=new google.maps.Marker({position:m[0].geometry.location,map:g.theMap,animation:google.maps.Animation.DROP,title:g.address});if(g.radiusCircle!=null){g.radiusCircle.setMap(null)}e(m[0].geometry.location);g.queryString=g.queryString+" AND ST_INTERSECTS("+g.potholeColumn+", CIRCLE(LATLNG"+m[0].geometry.location.toString()+","+g.searchRadius+"))";h(g.queryString)}else{alert("We could not locate your address: "+l)}})}else{if(g.addrMarker!=false){g.addrMarker.setMap(null)}if(g.radiusCircle!=null){g.radiusCircle.setMap(null)}g.isAddressRequest=false;$("#statResults").fadeOut(function(){$("#statResults").html("")});h(g.queryString)}}});function e(l){g.radiusCircleOptions={strokeColor:"#a0522d",strokeOpacity:0.4,strokeWeight:1,fillColor:"#a0522d",fillOpacity:0.05,map:g.theMap,center:l,clickable:false,zIndex:-1,radius:parseInt(g.searchRadius)};g.radiusCircle=new google.maps.Circle(g.radiusCircleOptions)}$("#map-all").click(function(){k();if(g.addrMarker!=false){g.addrMarker.setMap(null)}if(g.radiusCircle!=null){g.radiusCircle.setMap(null)}h(g.queryString);$("#year-creation").val("none");$("#year-completed").val("none");$("#address").val("");$("#statResults").fadeOut(function(){$("#statResults").html("")})});function h(l){g.potholeLayer.setMap(null);g.potholeLayer=new google.maps.FusionTablesLayer(g.potholeTableId,{query:l});g.potholeLayer.setMap(g.theMap);d(l)}g.wardLayer=new google.maps.FusionTablesLayer(g.wardTableId,{query:"SELECT "+g.wardColumn+" FROM "+g.wardTableId});$("#wards").click(function(){if($("#wards").is(":checked")){g.potholeLayer.setMap(null);g.wardLayer.setMap(g.theMap);g.potholeLayer.setMap(g.theMap)}else{g.wardLayer.setMap(null)}});function d(l){$("#numResults").fadeOut(function(){$("#numResults").html('<div class="alert"><strong>Calculating...</strong></div>')});$("#numResults").fadeIn();g.countQueryString=l.replace("SELECT "+g.potholeColumn,"SELECT Count() ");a(g.countQueryString).send(i);if(g.isStatsRequest&&g.isAddressRequest){b(l)}}function a(l){g.queryText=encodeURIComponent(l);return new google.visualization.Query("http://www.google.com/fusiontables/gvizdata?tq="+g.queryText)}function i(l){g.numRows=0;if(l.getDataTable().getNumberOfRows()>0){g.numRows=parseInt(l.getDataTable().getValue(0,0))}$("#numResults").fadeOut(function(){$("#statsResults").fadeOut();$("#numResults").html('<div class="alert alert-info"><strong>'+f(g.numRows)+"</strong> Requests Selected</div>")});$("#numResults").fadeIn()}function b(l){g.statQueryString=l.replace("SELECT "+g.potholeColumn,"SELECT CREATIONDATE, COMPLETIONDATE");a(g.statQueryString).send(j)}function j(l){g.numStatsRows=parseInt(l.getDataTable().getNumberOfRows());for(g.i=1;g.i<=6;g.i++){g.total[g.i]=0}for(g.i=0;g.i<g.numStatsRows;g.i++){g.createDates[g.i]=new XDate(l.getDataTable().getValue(g.i,0));g.completeDates[g.i]=new XDate(l.getDataTable().getValue(g.i,1));g.openComplete="DAYS TO COMPLETE REQUESTS";if(g.completeDates[g.i]=="21600000"){g.openComplete="DAYS SINCE REQUESTS OPENED";g.completeDates[g.i]=new XDate()}g.dateDiffs[g.i]=g.createDates[g.i].diffDays(g.completeDates[g.i]);if(g.dateDiffs[g.i]<3){g.total[1]++}else{if(g.dateDiffs[g.i]<6){g.total[2]++}else{if(g.dateDiffs[g.i]<9){g.total[3]++}else{if(g.dateDiffs[g.i]<12){g.total[4]++}else{if(g.dateDiffs[g.i]<15){g.total[5]++}else{g.total[6]++}}}}}}g.statResults.min=jStat.min(g.dateDiffs);g.statResults.max=jStat.max(g.dateDiffs);g.statResults.mean=jStat.mean(g.dateDiffs);g.statResults.median=jStat.median(g.dateDiffs);g.statResults.stdev=jStat.stdev(g.dateDiffs);for(g.i=1;g.i<=6;g.i++){g.flot[g.i]=[g.i,g.total[g.i]]}$("#statResults").fadeOut(function(){$("#statResults").html('<div class="alert alert-info"><strong>'+g.openComplete+"<br/>"+c(g.statResults.min,0)+"</strong> minimum<br/><strong>"+c(g.statResults.max,0)+"</strong> maximum<br/><strong>"+c(g.statResults.mean,1)+"</strong> average<br/><strong>"+c(g.statResults.median,1)+"</strong> median<br/><strong>"+c(g.statResults.stdev,1)+'</strong> standard deviation<div id="flot" style="width:240px;height:100px"></div><p>&nbsp;<br/>requests - vertical&nbsp;&nbsp;|&nbsp;&nbsp;days - horizonal</p></div>');$.plot($("#flot"),[{data:g.flot}],{bars:{show:true},xaxis:{ticks:[[1,"0"],[2,"3"],[3,"6"],[4,"9"],[5,"12"],[6,"15"],[7,"&#x221E;"]]}})});$("#statResults").fadeIn()}function f(l){l+="";g.subStr=l.split(".");g.subStr1=g.subStr[0];g.subStr2=g.subStr.length>1?"."+g.subStr[1]:"";g.regx=/(\d+)(\d{3})/;while(g.regx.test(g.subStr1)){g.subStr1=g.subStr1.replace(g.regx,"$1,$2")}return g.subStr1+g.subStr2}function c(l,m){g.roundResult=Math.round(l*Math.pow(10,m))/Math.pow(10,m);return g.roundResult}});